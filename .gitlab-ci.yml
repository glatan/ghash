stages:
  - test

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/cargo
  WASMTIME_VERSION: 0.20.0

before_script:
  - apt update -y
  - apt install -y make

cache:
  paths:
    - cargo/
    - target/

.cross_compile_template: &cross_compile_template
  image: amd64/debian:buster-slim
  script:
    - apt install -y curl qemu-user ${PACKAGES}
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs > setup.sh
    - sh setup.sh -y -t ${TARGET} --default-toolchain stable --profile minimal
    - source ${CI_PROJECT_DIR}/cargo/env
    - make test.${TARGET}

stable-aarch64-unknown-linux-gnu:
  variables:
    PACKAGES: gcc-aarch64-linux-gnu
    TARGET: aarch64-unknown-linux-gnu
  << : *cross_compile_template

.wasm32-wasi_template: &wasm32-wasi_template
  before_script:
    - rustc --version
    - rustup target add wasm32-wasi
    - apt update -y
    - apt install -y curl make xz-utils
    - curl -L "https://github.com/bytecodealliance/wasmtime/releases/download/v${WASMTIME_VERSION}/wasmtime-v${WASMTIME_VERSION}-x86_64-linux.tar.xz" > wasmtime-v${WASMTIME_VERSION}-x86_64-linux.tar.xz
    - tar -xvf wasmtime-v${WASMTIME_VERSION}-x86_64-linux.tar.xz
    - mv wasmtime-v${WASMTIME_VERSION}-x86_64-linux/wasmtime /usr/bin/
  script:
    - make test.wasm32-wasi

stable-i686-unknown-linux-gnu:
  stage: test
  image: i386/rust:slim-buster
  before_script:
    - apt update -y
    - apt install -y make
    - linux32 rustc --version
  script:
    - linux32 make test.i686-unknown-linux-gnu

stable-x86_64-unknown-linux-gnu:
  stage: test
  image: amd64/rust:slim-buster
  script:
    - make test.x86_64-unknown-linux-gnu

stable-wasm32-wasi:
  stage: test
  image: amd64/rust:slim-buster
  <<: *wasm32-wasi_template

nightly-x86_64-unknown-linux-gnu:
  stage: test
  image: rustlang/rust:nightly-buster-slim
  script:
    - make test.x86_64-unknown-linux-gnu

nightly-wasm32-wasi:
  stage: test
  image: rustlang/rust:nightly-buster-slim
  <<: *wasm32-wasi_template
